<html>
    <head>
        <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
        $(function(){
            var ps={L:[],R:[],T:[],B:[]};
                for(var i=2; i>=0; i--){
                    var oLi = $('.cube').eq(i),
                    gLi = oLi.get(0);        
                    oLi.css({'left':gLi.offsetLeft+'px','top':gLi.offsetTop+'px','position':'absolute'});
                    ps.L.push(gLi.offsetLeft);
                    ps.T.push(gLi.offsetTop);
                    ps.R.push(gLi.offsetLeft + gLi.offsetWidth);
                    ps.B.push(gLi.offsetTop + gLi.offsetHeight);        
                };
                ps.L = ps.L.reverse();
                ps.R = ps.R.reverse();
                ps.T = ps.T.reverse();
                ps.B = ps.B.reverse();  //储存位置
//              $(".cube").each(function(i,v){
//                $(v).css({'left':$(v).offsetLeft+'px','top':$(v).offsetTop+'px','position':'absolute'});
//                    ps.L.push($(v).offsetLeft);
//                    ps.T.push($(v).offsetTop);
//                    ps.R.push($(v).offsetLeft + $(v).offsetWidth);
//                    ps.B.push($(v).offsetTop + $(v).offsetHeight);        
//            });

            
          
                $(document).on('mousedown','.cube',function(e){
                    e.preventDefault();
                    var _this = this;
                    var X = e.clientX - _this.offsetLeft,
                        Y = e.clientY - _this.offsetTop,
                        oList = $('.cube'), 
                        attr = [];
                    var my_index = $( _this ).attr('index');     //初始保存一个原来的Index,回到原来的数组(位置)
                    $(_this).css({'opacity':0.9,'zIndex':1});
                    document.index = my_index;             //目的是为了脱离变量作用域         
                    $('.cube').each(function() {
                        attr.push( $(this).attr('index'));
                    });

                    $(document).on('mousemove',function(e){
                        var lt = e.clientX - X,
                            tp = e.clientY - Y,
                            screen_l = e.clientX - _this.parentNode.offsetLeft,
                            screen_t = e.clientY - _this.parentNode.offsetTop;
                        $(_this).css({'left':lt+'px','top':tp+'px'});

                        for(var i=0;i<2;i++){
                            var he_index = parseInt(oList.eq(i).attr('index'));
                            if(screen_l>ps.L[he_index] &&
                               screen_l<ps.R[he_index] &&
                               screen_t>ps.T[he_index] && 
                               screen_t<ps.B[he_index]){
                                var i_index = parseInt($(_this).attr('index'));
                                
                                if(he_index == i_index)continue;
                                console.info("move");
                                document.index = he_index;              //当找到元素保存要抵达的位置的index
                                var test = function (num,j){
                                    var he_Li = $('.cube[index='+j+']');
                                    $(he_Li).stop(); 
                                    he_Li.animate({
                                        left:ps.L[j+num],
                                        top:ps.T[j+num]
                                    },'fast');             
                                    console.info("he_id");
                                    he_Li.attr('index',j+num);         
                                };
                                //利用属性选择器找到对应index(也就是找到数组相应位置)的元素;并且变换属性index到相应的数组索引；
                                if(i_index>he_index){
                                    for(var j=i_index-1; j>=he_index; j--){
                                        test(1,j);
                                    }                                    
                                }else{
                                    for(var j=i_index+1; j<he_index+1; j++){ 
                                        
                                        test(-1,j); 
                                    }                                    
                                };
                                $(_this).attr('index',he_index);  //变换_this的index       
                            }else{
                                var parent = _this.parentNode,
                                        parent_X = e.clientX - parent.offsetLeft,
                                        parent_Y = e.clientY - parent.offsetTop;
                                    if( parent_X<0||
                                       parent_X>parent.offsetWidth||
                                       parent_Y<0||
                                       parent_Y>parent.offsetHeight ){
                                        
                                        oList.not(_this).each(function(index, element) {
                                            var a = $(element).index();
                                            $(element).animate({
                                                left:ps.L[attr[a]],
                                                top:ps.T[attr[a]]
                                            },'fast').attr('index',attr[a])     
                                        });
                                        document.index = my_index;
                                        $(_this).attr('index',my_index);
                                    }
                            };                        
                        };
                    });         
                    $(document).on('mouseup',function(){
                        $(this).off('mousemove');
                        $(this).off('mouseup'); 
                        $(_this).animate({
                            left:ps.L[document.index],
                            top:ps.T[document.index]         
                        },'fast',function(){
                            $(_this).css({'opacity':1,'zIndex':0})         
                        });
                        delete document.index;
                    });                 
                });
            }) 
    </script>

    </head>

    <body>
    
 <div style="position:relative; width:1100px; height:500px;">
     <div index = "0" class = "cube" style = "display:inline-block;width:100px;height:100px;background-color:#eee"></div>
     <div index = "1" class = "cube"  style = "display:inline-block;width:100px;height:100px;background-color:#eee"></div>
     <div index = "2" class = "cube"  style = "display:inline-block;width:100px;height:100px;background-color:#eee"></div>
    
  
  </div>
    </body>
</html>




